#!/usr/bin/env python3
"""Rips all samples contained by a specified MOD music file to WAV."""

import argparse
from pathlib import Path
import wave

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('mod_file', type=Path)
    args = parser.parse_args()
    with open(args.mod_file, 'rb') as file:
        mod_file = {}
        mod_file["title"] = file.read(20).decode('utf-8')
        mod_file["samples"] = []
        for i in range(31):
            sample = {}
            sample["name"] = file.read(22).strip(b'\x00\x0e').decode('utf-8').strip()
            sample["length"] = int.from_bytes(file.read(2), 'big') * 2
            finetune_value = int.from_bytes(file.read(1), 'big') & 0x0F
            # convert from base-16 to a signed nibble (-8..7)
            if finetune_value > 7:
                sample["finetune"] = finetune_value - 16
            else:
                sample["finetune"] = finetune_value
            sample["volume"] = int.from_bytes(file.read(1), 'big')
            sample["loop_offset"] = int.from_bytes(file.read(2), 'big')
            sample["loop_length"] = int.from_bytes(file.read(2), 'big')
            mod_file["samples"].append(sample)
        file.read(1) # number of song positions
        file.read(1) # this byte can be ignored
        mod_file["number_of_patterns"] = 0
        for i in range(128):
            pattern = int.from_bytes(file.read(1), 'big')
            if pattern > mod_file["number_of_patterns"]:
                mod_file["number_of_patterns"] = pattern
        identifier = file.read(4) # these bytes can be ignored
        mod_file["number_of_channels"] = 0
        if identifier == b'M.K.' or b'M!K!' or b'FLT4':
            mod_file["number_of_channels"] = 4
        elif identifier == b'6CHN':
            mod_file["number_of_channels"] = 6
        elif identifier == b'8CHN' or b'CD81' or b'OKTA' or b'OCTA' or b'FLT8':
            mod_file["number_of_channels"] = 8
        elif identifier == b'2CHN':
            mod_file["number_of_channels"] = 2
        assert(mod_file["number_of_channels"] > 0)
        print(str(mod_file["number_of_channels"]) + " channels")
        for i in range(mod_file["number_of_patterns"] + 1): # skip pattern data
            file.read(256 * mod_file["number_of_channels"])
        for i in range(len(mod_file["samples"])):
            sample = mod_file["samples"][i]
            if sample["length"] > 0:
                sample_file_name = str(i)
                if sample["name"] != "":
                    sample_file_name += " - " + sample["name"]
                keepcharacters = (' ','.','_','-')
                sample_file_name = "".join(c for c in sample_file_name if
                                           c.isalnum() or c in
                                           keepcharacters).rstrip()
                print("[Exporting Sample] " + sample_file_name)
                out = wave.open(sample_file_name + ".wav", "wb")
                out.setnchannels(1)
                out.setsampwidth(2)
                # Amiga Paula clock rate closest to C at 8372Hz
                out.setframerate(8363)
                out.writeframes(file.read(sample["length"]))
                out.close()


if __name__ == '__main__':
    main()
